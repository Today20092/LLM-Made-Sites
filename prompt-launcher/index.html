<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Prompt Launcher</title>
    <meta
      name="description"
      content="Create an AI prompt, fill variables like {{name}}, and share it with a compact link. Launch in multiple chatbots."
    />

    <meta property="og:title" content="AI Prompt Launcher" />
    <meta
      property="og:description"
      content="Share prompts with variables and launch them across multiple AI chatbots."
    />
    <meta property="og:type" content="website" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>

    <!--
      Compression changes:
      - Prefer Brotli via WASM (lazy-loaded) for better ratio on short JSON.
      - Fallback to LZ-String if Brotli fails to load.
    -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

    <style>
      #toast {
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.98);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out;
      }
    </style>
  </head>

  <body
    class="bg-gray-100 dark:bg-gray-900 min-h-screen p-4 sm:p-6 transition-colors duration-200"
  >
    <div class="max-w-4xl mx-auto">
      <div
        class="bg-white dark:bg-gray-800/60 dark:backdrop-blur-sm rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 p-6 sm:p-8 relative fade-in"
      >
        <!-- Theme Toggle (manual only: ignores browser preference) -->
        <button
          id="themeToggle"
          class="absolute top-4 right-4 p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          aria-label="Toggle dark mode"
        >
          <svg
            id="sunIcon"
            class="h-6 w-6 hidden text-yellow-400"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
              clip-rule="evenodd"
            />
          </svg>
          <svg
            id="moonIcon"
            class="h-6 w-6 text-gray-700 dark:text-gray-200"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"
            />
          </svg>
        </button>

        <header class="text-center mb-8">
          <h1
            class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white"
          >
            AI Prompt Launcher
          </h1>
          <p class="text-gray-600 dark:text-gray-300 mt-2 text-sm sm:text-base">
            Write a prompt once, fill variables like <code>{{name}}</code>,
            share it, and launch it across multiple chatbots.
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
            Shortcuts:
            <kbd
              class="px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs"
              >Ctrl+Enter</kbd
            >
            copy filled prompt â€¢
            <kbd
              class="px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs"
              >Ctrl+K</kbd
            >
            clear â€¢
            <kbd
              class="px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 rounded text-xs"
              >Esc</kbd
            >
            close modal
          </p>
        </header>

        <!-- Metadata -->
        <section class="mb-6">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <div class="sm:col-span-2">
              <label
                for="titleInput"
                class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1"
                >Title (optional)</label
              >
              <input
                id="titleInput"
                type="text"
                class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"
                placeholder="e.g., Cold email prompt for recruiters"
              />
            </div>

            <div class="sm:col-span-1">
              <label
                for="tagsInput"
                class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1"
                >Tags (optional)</label
              >
              <input
                id="tagsInput"
                type="text"
                class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400"
                placeholder="job, email, tone"
              />
            </div>
          </div>

          <div class="mt-3">
            <button
              id="toggleNotes"
              class="text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300"
              type="button"
            >
              + Add notes
            </button>

            <div id="notesWrap" class="hidden mt-2">
              <label
                for="notesInput"
                class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1"
                >Notes (optional)</label
              >
              <textarea
                id="notesInput"
                class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 resize-y min-h-[90px]"
                placeholder="Add context for the recipient (who, why, constraints, tone, etc.)"
              ></textarea>
            </div>
          </div>
        </section>

        <!-- Prompt -->
        <section class="mb-6">
          <div class="flex items-center justify-between mb-2">
            <label
              for="promptInput"
              class="text-lg font-semibold text-gray-700 dark:text-gray-200"
              >Prompt Template</label
            >
            <div class="text-sm text-gray-500 dark:text-gray-400">
              <span id="charCount">0 characters</span>
            </div>
          </div>

          <textarea
            id="promptInput"
            class="w-full p-4 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 resize-y min-h-[180px]"
            placeholder="Write your prompt here...

Use variables like:
- Hello {{name}}
- Company: {{company-name}}
- Goal: {{goal}}"
          ></textarea>

          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
            Tip: Variables are detected automatically from <code>{{...}}</code>
            patterns.
          </p>
        </section>

        <!-- Variables -->
        <section
          id="varsSection"
          class="hidden mb-6 border border-gray-200 dark:border-gray-700 rounded-xl p-4 bg-white/50 dark:bg-gray-800/40"
        >
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-base font-bold text-gray-800 dark:text-white">
              Fill Variables
            </h2>
            <button
              id="resetVarsBtn"
              class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white"
              type="button"
            >
              Reset
            </button>
          </div>

          <div id="varsList" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <!-- Variable inputs inserted here -->
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between gap-3 mb-2">
              <h3
                class="text-sm font-semibold text-gray-700 dark:text-gray-200"
              >
                Filled Prompt Preview
              </h3>
              <span
                id="missingVarsHint"
                class="text-xs text-amber-700 dark:text-amber-300 hidden"
              ></span>
            </div>
            <textarea
              id="filledPreview"
              class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 resize-y min-h-[110px]"
              readonly
            ></textarea>
          </div>
        </section>

        <!-- Actions -->
        <section class="flex flex-wrap gap-3 items-center justify-center mb-8">
          <button
            id="copyFilledBtn"
            disabled
            class="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            Copy Filled Prompt
          </button>

          <button
            id="shareBtn"
            disabled
            class="flex items-center justify-center gap-2 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 dark:focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            Share
          </button>

          <button
            id="clearBtn"
            class="flex items-center justify-center gap-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:focus:ring-offset-gray-900"
          >
            Clear
          </button>
        </section>

        <!-- Launch -->
        <section class="border-t border-gray-200 dark:border-gray-700 pt-8">
          <h2
            class="text-2xl font-bold text-gray-800 dark:text-white mb-2 text-center"
          >
            Launch in AI Chatbots
          </h2>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-6 text-center">
            For chatbots that donâ€™t support URL autofill, this tool will copy
            the filled prompt firstâ€”then open the site.
          </p>

          <div
            id="chatbotButtons"
            class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4"
          ></div>
        </section>
      </div>
    </div>

    <!-- Toast -->
    <div
      id="toast"
      class="fixed bottom-5 left-1/2 -translate-x-1/2 opacity-0 translate-y-2 pointer-events-none"
    >
      <div
        class="px-4 py-2 rounded-lg shadow-lg bg-gray-900 text-white text-sm"
      >
        <span id="toastText">Copied</span>
      </div>
    </div>

    <!-- Share Modal -->
    <div
      id="shareModal"
      class="fixed inset-0 hidden items-center justify-center p-4 bg-black/50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="shareTitle"
    >
      <div
        class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 p-5"
      >
        <div class="flex items-start justify-between gap-4">
          <div>
            <h3
              id="shareTitle"
              class="text-xl font-bold text-gray-900 dark:text-white"
            >
              Share
            </h3>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
              Choose the simplest format for the recipient.
            </p>
          </div>

          <button
            id="closeShareModal"
            class="px-3 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100"
            type="button"
          >
            Close
          </button>
        </div>

        <div class="mt-4">
          <div class="flex flex-wrap gap-2">
            <button
              class="shareTab px-3 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white"
              data-tab="link"
              type="button"
            >
              Share Link (Recommended)
            </button>
            <button
              class="shareTab px-3 py-2 rounded-lg text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100"
              data-tab="filled"
              type="button"
            >
              Copy Filled Prompt
            </button>
            <button
              class="shareTab px-3 py-2 rounded-lg text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100"
              data-tab="template"
              type="button"
            >
              Copy Template
            </button>
            <button
              class="shareTab px-3 py-2 rounded-lg text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100"
              data-tab="message"
              type="button"
            >
              Copy Message
            </button>
          </div>

          <!-- Tab: Link -->
          <div id="tab-link" class="sharePanel mt-4">
            <div class="flex flex-col gap-3 mb-2">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center gap-3">
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input
                      id="includeVarsInLink"
                      type="checkbox"
                      class="accent-indigo-600"
                      checked
                    />
                    <span class="text-gray-700 dark:text-gray-200"
                      >Include filled variable values</span
                    >
                  </label>

                  <label class="inline-flex items-center gap-2 text-sm">
                    <input
                      id="includeMetaInLink"
                      type="checkbox"
                      class="accent-indigo-600"
                      checked
                    />
                    <span class="text-gray-700 dark:text-gray-200"
                      >Include title/notes/tags</span
                    >
                  </label>
                </div>

                <span class="text-xs text-gray-500 dark:text-gray-400">
                  Uses Brotli (WASM) + Base64URL when available.
                </span>
              </div>

              <!-- C3: Canonicalize/minify toggle -->
              <div class="flex flex-wrap items-center gap-4">
                <label class="inline-flex items-center gap-2 text-sm">
                  <input
                    id="canonicalizeInLink"
                    type="checkbox"
                    class="accent-indigo-600"
                    checked
                  />
                  <span class="text-gray-700 dark:text-gray-200"
                    >Minify whitespace in template & vars (smaller link)</span
                  >
                </label>
                <span class="text-xs text-gray-500 dark:text-gray-400">
                  Trims trailing spaces and collapses 3+ blank lines to 2.
                </span>
              </div>
            </div>

            <div class="flex gap-2">
              <input
                id="shareLinkInput"
                class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100"
                readonly
              />
              <button
                id="copyLinkBtn"
                class="px-4 py-2 rounded-lg bg-teal-600 hover:bg-teal-700 text-white font-semibold"
                type="button"
              >
                Copy
              </button>
            </div>

            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
              Backward compatible: old links using
              <code>?prompt=...</code> still load correctly.
            </p>
          </div>

          <!-- Tab: Filled -->
          <div id="tab-filled" class="sharePanel mt-4 hidden">
            <textarea
              id="shareFilledPreview"
              class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 resize-y min-h-[160px]"
              readonly
            ></textarea>

            <div class="flex gap-2 mt-3">
              <button
                id="copyFilledFromModalBtn"
                class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold"
                type="button"
              >
                Copy Filled Prompt
              </button>
            </div>
          </div>

          <!-- Tab: Template -->
          <div id="tab-template" class="sharePanel mt-4 hidden">
            <textarea
              id="shareTemplatePreview"
              class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 resize-y min-h-[160px]"
              readonly
            ></textarea>

            <div class="flex gap-2 mt-3">
              <button
                id="copyTemplateBtn"
                class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold"
                type="button"
              >
                Copy Template
              </button>
            </div>
          </div>

          <!-- Tab: Message -->
          <div id="tab-message" class="sharePanel mt-4 hidden">
            <textarea
              id="shareMessagePreview"
              class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 resize-y min-h-[180px]"
              readonly
            ></textarea>

            <div class="flex gap-2 mt-3">
              <button
                id="copyMessageBtn"
                class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold"
                type="button"
              >
                Copy Message
              </button>
            </div>

            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
              Message includes title/notes (if provided), the filled prompt, and
              your share link.
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      /**
       * THEME (manual toggle only)
       * - Defaults to light
       * - Remembers user preference in localStorage
       */
      (function initTheme() {
        const saved = localStorage.getItem("theme"); // "dark" | "light" | null
        if (saved === "dark") document.documentElement.classList.add("dark");
      })();

      /**
       * C1) Better codec (Brotli WASM) + denser encoding (Base64URL)
       * - Lazy loads Brotli encoder/decoder. Falls back to LZ-String.
       *
       * Note: this uses a CDN package that provides brotli compress/decompress
       * with an internal WASM module. If it fails to load, links still work via
       * LZ-String ("p=") and legacy "?prompt=".
       */
      const Codec = (() => {
        let brotliApiPromise = null;

        async function loadBrotliApi() {
          if (brotliApiPromise) return brotliApiPromise;
          brotliApiPromise = (async () => {
            // Try multiple likely entry points to keep it robust.
            // If none load, we throw and caller will fallback.
            const urls = [
              "https://cdn.jsdelivr.net/npm/brotli-wasm@3.0.1/index.min.js",
              "https://cdn.jsdelivr.net/npm/brotli-wasm@3.0.1/esm/index.min.js",
            ];

            let lastErr = null;
            for (const url of urls) {
              try {
                const mod = await import(url);
                // Different builds expose different names; normalize:
                // - compress/decompress as Uint8Array <-> Uint8Array
                const api =
                  mod?.default || mod || (mod?.brotli && mod) || mod?.brotli;
                const compress =
                  api?.compress ||
                  api?.brotliCompress ||
                  api?.encode ||
                  api?.brotliEncode;
                const decompress =
                  api?.decompress ||
                  api?.brotliDecompress ||
                  api?.decode ||
                  api?.brotliDecode;

                if (typeof compress !== "function") continue;
                if (typeof decompress !== "function") continue;

                return { compress, decompress };
              } catch (e) {
                lastErr = e;
              }
            }
            throw lastErr || new Error("Failed to load brotli-wasm");
          })();

          return brotliApiPromise;
        }

        function bytesToBase64Url(bytes) {
          let binary = "";
          const chunkSize = 0x8000;
          for (let i = 0; i < bytes.length; i += chunkSize) {
            const chunk = bytes.subarray(i, i + chunkSize);
            binary += String.fromCharCode(...chunk);
          }
          const b64 = btoa(binary);
          return b64
            .replace(/\+/g, "-")
            .replace(/\//g, "_")
            .replace(/=+$/g, "");
        }

        function base64UrlToBytes(b64url) {
          let b64 = b64url.replace(/-/g, "+").replace(/_/g, "/");
          const pad = b64.length % 4;
          if (pad) b64 += "=".repeat(4 - pad);
          const binary = atob(b64);
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          return bytes;
        }

        function utf8ToBytes(str) {
          return new TextEncoder().encode(str);
        }

        function bytesToUtf8(bytes) {
          return new TextDecoder().decode(bytes);
        }

        async function brotliCompressToB64Url(str) {
          const api = await loadBrotliApi();
          const input = utf8ToBytes(str);

          // Some implementations accept (data, options); others only (data).
          let out;
          try {
            out = api.compress(input, { quality: 11 });
          } catch {
            out = api.compress(input);
          }
          if (!(out instanceof Uint8Array)) out = new Uint8Array(out);
          return bytesToBase64Url(out);
        }

        async function brotliDecompressFromB64Url(b64url) {
          const api = await loadBrotliApi();
          const input = base64UrlToBytes(b64url);

          let out;
          try {
            out = api.decompress(input);
          } catch (e) {
            // Some APIs expect ArrayBuffer.
            out = api.decompress(input.buffer);
          }
          if (!(out instanceof Uint8Array)) out = new Uint8Array(out);
          return bytesToUtf8(out);
        }

        return {
          brotliCompressToB64Url,
          brotliDecompressFromB64Url,
        };
      })();

      document.addEventListener("DOMContentLoaded", () => {
        // --- Elements
        const themeToggle = document.getElementById("themeToggle");
        const sunIcon = document.getElementById("sunIcon");
        const moonIcon = document.getElementById("moonIcon");

        const titleInput = document.getElementById("titleInput");
        const tagsInput = document.getElementById("tagsInput");
        const toggleNotes = document.getElementById("toggleNotes");
        const notesWrap = document.getElementById("notesWrap");
        const notesInput = document.getElementById("notesInput");

        const promptInput = document.getElementById("promptInput");
        const charCount = document.getElementById("charCount");

        const varsSection = document.getElementById("varsSection");
        const varsList = document.getElementById("varsList");
        const resetVarsBtn = document.getElementById("resetVarsBtn");
        const filledPreview = document.getElementById("filledPreview");
        const missingVarsHint = document.getElementById("missingVarsHint");

        const copyFilledBtn = document.getElementById("copyFilledBtn");
        const shareBtn = document.getElementById("shareBtn");
        const clearBtn = document.getElementById("clearBtn");

        const chatbotButtons = document.getElementById("chatbotButtons");

        const toast = document.getElementById("toast");
        const toastText = document.getElementById("toastText");

        // Share modal
        const shareModal = document.getElementById("shareModal");
        const closeShareModal = document.getElementById("closeShareModal");
        const shareTabs = Array.from(document.querySelectorAll(".shareTab"));
        const sharePanels = Array.from(
          document.querySelectorAll(".sharePanel")
        );
        const includeVarsInLink = document.getElementById("includeVarsInLink");
        const includeMetaInLink = document.getElementById("includeMetaInLink");
        const canonicalizeInLink =
          document.getElementById("canonicalizeInLink");
        const shareLinkInput = document.getElementById("shareLinkInput");
        const copyLinkBtn = document.getElementById("copyLinkBtn");
        const shareFilledPreview =
          document.getElementById("shareFilledPreview");
        const shareTemplatePreview = document.getElementById(
          "shareTemplatePreview"
        );
        const shareMessagePreview = document.getElementById(
          "shareMessagePreview"
        );
        const copyFilledFromModalBtn = document.getElementById(
          "copyFilledFromModalBtn"
        );
        const copyTemplateBtn = document.getElementById("copyTemplateBtn");
        const copyMessageBtn = document.getElementById("copyMessageBtn");

        // --- Chatbots config
        const chatbotsConfig = [
          {
            name: "ChatGPT",
            icon: "ðŸ’¬",
            supportsQueryParam: true,
            urlTemplate:
              "https://chatgpt.com/?q={{{s}}}&hints=search&temporary-chat=true",
            className:
              "bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 dark:from-green-700 dark:to-green-800 dark:hover:from-green-800 dark:hover:to-green-900",
          },
          {
            name: "Claude",
            icon: "ðŸ§ ",
            supportsQueryParam: false,
            urlTemplate: "https://claude.ai/new",
            className:
              "bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-700 hover:to-amber-800 dark:from-amber-700 dark:to-amber-800 dark:hover:from-amber-800 dark:hover:to-amber-900",
          },
          {
            name: "Perplexity",
            icon: "ðŸ”",
            supportsQueryParam: true,
            urlTemplate: "https://perplexity.ai/?q={{{s}}}",
            className:
              "bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 dark:from-purple-700 dark:to-purple-800 dark:hover:from-purple-800 dark:hover:to-purple-900",
          },
          {
            name: "T3 Chat",
            icon: "ðŸ¤–",
            supportsQueryParam: true,
            urlTemplate: "https://t3.chat/new?q={{{s}}}",
            className:
              "bg-gradient-to-r from-blue-700 to-blue-800 hover:from-blue-800 hover:to-blue-900 dark:from-blue-800 dark:to-blue-900 dark:hover:from-blue-900 dark:hover:to-blue-950",
          },
          {
            name: "Google Gemini",
            icon: "âœ¨",
            supportsQueryParam: false,
            urlTemplate: "https://gemini.google.com/app",
            className:
              "bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 dark:from-blue-600 dark:to-blue-700 dark:hover:from-blue-700 dark:hover:to-blue-800",
          },
        ];

        // --- App state
        const state = {
          title: "",
          tags: "",
          notes: "",
          template: "",
          vars: {}, // { [varName]: value }
        };

        /**
         * UI helpers
         */
        function updateThemeIcons() {
          const isDark = document.documentElement.classList.contains("dark");
          if (isDark) {
            sunIcon.classList.remove("hidden");
            moonIcon.classList.add("hidden");
          } else {
            sunIcon.classList.add("hidden");
            moonIcon.classList.remove("hidden");
          }
        }

        function showToast(message) {
          toastText.textContent = message;
          toast.classList.remove("opacity-0", "translate-y-2");
          toast.classList.add("opacity-100", "translate-y-0");
          window.setTimeout(() => {
            toast.classList.add("opacity-0", "translate-y-2");
            toast.classList.remove("opacity-100", "translate-y-0");
          }, 1600);
        }

        async function copyToClipboard(text) {
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch {
            try {
              const temp = document.createElement("textarea");
              temp.value = text;
              temp.setAttribute("readonly", "");
              temp.style.position = "absolute";
              temp.style.left = "-9999px";
              document.body.appendChild(temp);
              temp.select();
              document.execCommand("copy");
              document.body.removeChild(temp);
              return true;
            } catch {
              return false;
            }
          }
        }

        function escapeRegex(s) {
          return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        }

        /**
         * C3) Canonicalize/minify template & vars
         * - Conservative: trim trailing spaces; collapse 3+ blank lines to 2;
         *   normalize CRLF -> LF; trim outer whitespace.
         * - This is optional via toggle in share modal.
         */
        function canonicalizeText(s) {
          if (!s) return "";
          let out = String(s);
          out = out.replace(/\r\n/g, "\n");
          out = out.replace(/[ \t]+\n/g, "\n");
          out = out.replace(/\n{3,}/g, "\n\n");
          out = out.trim();
          return out;
        }

        function canonicalizeVarsObject(varsObj) {
          const entries = Object.entries(varsObj || {})
            .map(([k, v]) => [String(k), canonicalizeText(String(v || ""))])
            // Keep empties (they matter for UI), but share serializer can drop them.
            .sort((a, b) => a[0].localeCompare(b[0]));
          return entries;
        }

        /**
         * Variables: detect {{var}} tokens
         */
        function extractVariables(template) {
          const re = /\{\{\s*([^{}]+?)\s*\}\}/g;
          const found = [];
          const seen = new Set();

          let match;
          while ((match = re.exec(template)) !== null) {
            const raw = match[1].trim();
            if (!raw) continue;
            if (seen.has(raw)) continue;
            seen.add(raw);
            found.push(raw);
          }

          return found;
        }

        function resolveTemplate(template, vars) {
          const keys = Object.keys(vars);

          let result = template;
          keys.forEach((key) => {
            const value = (vars[key] || "").trim();
            if (!value) return;

            const re = new RegExp(
              "\\{\\{\\s*" + escapeRegex(key) + "\\s*\\}\\}",
              "g"
            );
            result = result.replace(re, value);
          });

          return result;
        }

        function countMissingVars(varKeys) {
          return varKeys.filter((k) => !(state.vars[k] || "").trim()).length;
        }

        function renderVariables(varKeys) {
          Object.keys(state.vars).forEach((k) => {
            if (!varKeys.includes(k)) delete state.vars[k];
          });

          if (varKeys.length === 0) {
            varsSection.classList.add("hidden");
            varsList.innerHTML = "";
            filledPreview.value = resolveTemplate(state.template, state.vars);
            missingVarsHint.classList.add("hidden");
            return;
          }

          varsSection.classList.remove("hidden");
          varsList.innerHTML = "";

          varKeys.forEach((key) => {
            if (state.vars[key] === undefined) state.vars[key] = "";

            const wrap = document.createElement("div");
            wrap.className =
              "bg-gray-50 dark:bg-gray-700/60 border border-gray-200 dark:border-gray-600 rounded-lg p-3";

            wrap.innerHTML = `
              <label class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">
                ${key}
              </label>
             <textarea
              data-var-key="${key}"
              rows="2"
              class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:focus:ring-indigo-400 resize-y overflow-hidden"
              placeholder="Enter value for {{${key}}}"
              ></textarea>
            `;

            varsList.appendChild(wrap);

            const input = wrap.querySelector(`[data-var-key="${key}"]`);
            input.value = state.vars[key];

            input.addEventListener("input", () => {
              state.vars[key] = input.value;
              updateDerivedViews();
            });
          });

          updateDerivedViews();
        }

        /**
         * C2) Shrink JSON before compressing
         * - Use short keys.
         * - Omit defaults/empties.
         * - Store vars as array of pairs (sorted) rather than object.
         *
         * New payload format:
         *  {
         *    v: 2,
         *    t?: title,
         *    g?: tags,
         *    n?: notes,
         *    p: template,
         *    r?: [[key,value], ...]   // only non-empty values if includeVars
         *    c?: 1                   // canonicalize flag
         *  }
         *
         * Encoding:
         * - Preferred: #b=<brotli+base64url>
         * - Fallback:  #p=<lz-string encodedURIComponent>  (v:1 compatible)
         */
        function serializeShareStateV2(options) {
          const includeVars = options.includeVars;
          const includeMeta = options.includeMeta;
          const canonicalize = options.canonicalize;

          const payload = { v: 2 };

          const title = includeMeta ? state.title : "";
          const tags = includeMeta ? state.tags : "";
          const notes = includeMeta ? state.notes : "";
          const template = state.template;

          const tpl = canonicalize ? canonicalizeText(template) : template;

          if (tpl && tpl.trim()) payload.p = tpl;
          if (title && title.trim()) payload.t = title.trim();
          if (tags && tags.trim()) payload.g = tags.trim();
          if (notes && notes.trim()) payload.n = notes.trim();
          if (canonicalize) payload.c = 1;

          if (includeVars) {
            const pairs = canonicalize
              ? canonicalizeVarsObject(state.vars)
              : Object.entries(state.vars || {})
                  .map(([k, v]) => [String(k), String(v || "")])
                  .sort((a, b) => a[0].localeCompare(b[0]));

            const nonEmpty = pairs.filter(
              ([, v]) => String(v).trim().length > 0
            );
            if (nonEmpty.length > 0) payload.r = nonEmpty;
          }

          return payload;
        }

        function buildBaseUrl() {
          return `${window.location.origin}${window.location.pathname}`;
        }

        async function buildShareLink(options) {
          const payload = serializeShareStateV2(options);
          const json = JSON.stringify(payload);

          // Preferred: Brotli + Base64URL in hash
          try {
            const b64url = await Codec.brotliCompressToB64Url(json);
            return `${buildBaseUrl()}#b=${b64url}`;
          } catch {
            // Fallback: LZ-string (URL-safe), still smaller than raw
            const compressed = LZString.compressToEncodedURIComponent(json);
            return `${buildBaseUrl()}#p=${compressed}`;
          }
        }

        async function tryLoadFromUrl() {
          const params = new URLSearchParams(window.location.search);
          const hash = window.location.hash.startsWith("#")
            ? window.location.hash.slice(1)
            : "";
          const hashParams = new URLSearchParams(hash);

          // 1) New brotli format: #b=...
          const b = hashParams.get("b") || params.get("b");
          if (b) {
            try {
              const json = await Codec.brotliDecompressFromB64Url(b);
              const data = JSON.parse(json);

              if (!data || typeof data !== "object") return false;

              // v2 preferred
              if (data.v === 2) {
                state.title = String(data.t || "");
                state.tags = String(data.g || "");
                state.notes = String(data.n || "");
                state.template = String(data.p || "");
                state.vars = {};

                if (Array.isArray(data.r)) {
                  data.r.forEach((pair) => {
                    if (!Array.isArray(pair) || pair.length < 2) return;
                    const k = String(pair[0] || "");
                    const v = String(pair[1] || "");
                    if (!k) return;
                    state.vars[k] = v;
                  });
                }
                return true;
              }

              // If some other structure: attempt to map common fields
              state.title = String(data.title || "");
              state.tags = String(data.tags || "");
              state.notes = String(data.notes || "");
              state.template = String(data.template || "");
              state.vars =
                data.vars && typeof data.vars === "object" ? data.vars : {};
              return true;
            } catch {
              // Fall through to other formats
            }
          }

          // 2) LZ-string format: #p=... or ?p=...
          const compressed = hashParams.get("p") || params.get("p");
          if (compressed) {
            try {
              const json =
                LZString.decompressFromEncodedURIComponent(compressed);
              if (!json) return false;

              const data = JSON.parse(json);
              if (!data || typeof data !== "object") return false;

              if (data.v === 2) {
                state.title = String(data.t || "");
                state.tags = String(data.g || "");
                state.notes = String(data.n || "");
                state.template = String(data.p || "");
                state.vars = {};
                if (Array.isArray(data.r)) {
                  data.r.forEach((pair) => {
                    if (!Array.isArray(pair) || pair.length < 2) return;
                    const k = String(pair[0] || "");
                    const v = String(pair[1] || "");
                    if (!k) return;
                    state.vars[k] = v;
                  });
                }
                return true;
              }

              // v1 legacy object keys
              state.title = String(data.title || "");
              state.tags = String(data.tags || "");
              state.notes = String(data.notes || "");
              state.template = String(data.template || "");
              state.vars =
                data.vars && typeof data.vars === "object" ? data.vars : {};
              return true;
            } catch {
              return false;
            }
          }

          // 3) Backward compatible format: ?prompt=...
          const legacyPrompt = params.get("prompt");
          if (legacyPrompt) {
            const decoded = decodeURIComponent(
              legacyPrompt.replace(/\+/g, " ")
            );
            state.template = decoded;

            const legacyTitle = params.get("title");
            const legacyNotes = params.get("notes");
            const legacyTags = params.get("tags");

            if (legacyTitle)
              state.title = decodeURIComponent(legacyTitle.replace(/\+/g, " "));
            if (legacyNotes)
              state.notes = decodeURIComponent(legacyNotes.replace(/\+/g, " "));
            if (legacyTags)
              state.tags = decodeURIComponent(legacyTags.replace(/\+/g, " "));

            return true;
          }

          return false;
        }

        /**
         * Derived views:
         */
        function getFilledPrompt() {
          return resolveTemplate(state.template, state.vars);
        }

        function updateChatbotButtons() {
          const filled = getFilledPrompt();
          const encoded = encodeURIComponent(filled);

          const buttons = chatbotButtons.querySelectorAll("[data-bot-name]");
          buttons.forEach((btn) => {
            const botName = btn.getAttribute("data-bot-name");
            const bot = chatbotsConfig.find((b) => b.name === botName);
            if (!bot) return;

            if (bot.supportsQueryParam) {
              btn.href = bot.urlTemplate.replace("{{{s}}}", encoded);
            } else {
              btn.href = bot.urlTemplate;
            }
          });
        }

        function updateDerivedViews() {
          charCount.textContent = `${state.template.length} character${
            state.template.length === 1 ? "" : "s"
          }`;

          const varKeys = extractVariables(state.template);
          const filled = getFilledPrompt();
          filledPreview.value = filled;

          if (varKeys.length > 0) {
            const missing = countMissingVars(varKeys);
            if (missing > 0) {
              missingVarsHint.textContent = `${missing} variable${
                missing === 1 ? "" : "s"
              } not filled`;
              missingVarsHint.classList.remove("hidden");
            } else {
              missingVarsHint.classList.add("hidden");
            }
          } else {
            missingVarsHint.classList.add("hidden");
          }

          const hasPrompt = !!state.template.trim();
          copyFilledBtn.disabled = !hasPrompt;
          shareBtn.disabled = !hasPrompt;

          updateChatbotButtons();
        }

        /**
         * Share modal rendering
         */
        function setShareTab(tabName) {
          shareTabs.forEach((t) => {
            const isActive = t.dataset.tab === tabName;
            t.className = isActive
              ? "shareTab px-3 py-2 rounded-lg text-sm font-semibold bg-indigo-600 text-white"
              : "shareTab px-3 py-2 rounded-lg text-sm font-semibold bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100";
          });

          sharePanels.forEach((p) => p.classList.add("hidden"));
          const active = document.getElementById(`tab-${tabName}`);
          if (active) active.classList.remove("hidden");
        }

        async function refreshShareModalPreviews() {
          const link = await buildShareLink({
            includeVars: includeVarsInLink.checked,
            includeMeta: includeMetaInLink.checked,
            canonicalize: canonicalizeInLink.checked,
          });
          shareLinkInput.value = link;

          shareFilledPreview.value = getFilledPrompt();
          shareTemplatePreview.value = state.template;

          const lines = [];
          if (state.title.trim()) lines.push(`Title: ${state.title.trim()}`);
          if (state.tags.trim()) lines.push(`Tags: ${state.tags.trim()}`);
          if (state.notes.trim()) {
            lines.push("");
            lines.push("Notes:");
            lines.push(state.notes.trim());
          }
          lines.push("");
          lines.push("Prompt:");
          lines.push(getFilledPrompt());
          lines.push("");
          lines.push("Open in Prompt Launcher:");
          lines.push(link);

          shareMessagePreview.value = lines.join("\n");
        }

        /**
         * Create chatbot buttons once
         */
        function createChatbotButtons() {
          chatbotButtons.innerHTML = "";

          chatbotsConfig.forEach((bot) => {
            const a = document.createElement("a");
            a.setAttribute("data-bot-name", bot.name);
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.className = `flex items-center justify-center p-4 rounded-lg shadow-lg font-bold text-white text-base ${bot.className} transition-all duration-200 ease-in-out transform hover:-translate-y-1 text-center`;
            a.innerHTML = `<span class="text-2xl mr-2">${bot.icon}</span>${bot.name}`;

            a.addEventListener("click", async (e) => {
              if (bot.supportsQueryParam) return;

              e.preventDefault();
              const ok = await copyToClipboard(getFilledPrompt());
              if (ok) showToast("Copied â€” paste into the chatbot");

              window.open(bot.urlTemplate, "_blank", "noopener,noreferrer");
            });

            chatbotButtons.appendChild(a);
          });
        }

        /**
         * Event wiring
         */
        themeToggle.addEventListener("click", () => {
          const isDark = document.documentElement.classList.toggle("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
          updateThemeIcons();
        });

        toggleNotes.addEventListener("click", () => {
          const isHidden = notesWrap.classList.toggle("hidden");
          toggleNotes.textContent = isHidden ? "+ Add notes" : "âˆ’ Hide notes";
        });

        promptInput.addEventListener("input", () => {
          state.template = promptInput.value;

          const varKeys = extractVariables(state.template);
          renderVariables(varKeys);
          updateDerivedViews();
        });

        titleInput.addEventListener("input", () => {
          state.title = titleInput.value;
        });

        tagsInput.addEventListener("input", () => {
          state.tags = tagsInput.value;
        });

        notesInput.addEventListener("input", () => {
          state.notes = notesInput.value;
        });

        resetVarsBtn.addEventListener("click", () => {
          Object.keys(state.vars).forEach((k) => (state.vars[k] = ""));
          const varKeys = extractVariables(state.template);
          renderVariables(varKeys);
          updateDerivedViews();
          showToast("Variables reset");
        });

        copyFilledBtn.addEventListener("click", async () => {
          const ok = await copyToClipboard(getFilledPrompt());
          if (ok) showToast("Filled prompt copied");
        });

        clearBtn.addEventListener("click", () => {
          state.title = "";
          state.tags = "";
          state.notes = "";
          state.template = "";
          state.vars = {};

          titleInput.value = "";
          tagsInput.value = "";
          notesInput.value = "";
          promptInput.value = "";

          varsSection.classList.add("hidden");
          varsList.innerHTML = "";
          filledPreview.value = "";
          updateDerivedViews();

          showToast("Cleared");
          promptInput.focus();
        });

        // Share modal open/close
        shareBtn.addEventListener("click", async () => {
          await refreshShareModalPreviews();
          setShareTab("link");
          shareModal.classList.remove("hidden");
          shareModal.classList.add("flex");
        });

        closeShareModal.addEventListener("click", () => {
          shareModal.classList.add("hidden");
          shareModal.classList.remove("flex");
        });

        shareModal.addEventListener("click", (e) => {
          if (e.target === shareModal) {
            shareModal.classList.add("hidden");
            shareModal.classList.remove("flex");
          }
        });

        shareTabs.forEach((t) => {
          t.addEventListener("click", () => {
            setShareTab(t.dataset.tab);
          });
        });

        includeVarsInLink.addEventListener("change", refreshShareModalPreviews);
        includeMetaInLink.addEventListener("change", refreshShareModalPreviews);
        canonicalizeInLink.addEventListener(
          "change",
          refreshShareModalPreviews
        );

        copyLinkBtn.addEventListener("click", async () => {
          await refreshShareModalPreviews();
          const ok = await copyToClipboard(shareLinkInput.value);
          if (ok) showToast("Share link copied");
        });

        copyFilledFromModalBtn.addEventListener("click", async () => {
          const ok = await copyToClipboard(getFilledPrompt());
          if (ok) showToast("Filled prompt copied");
        });

        copyTemplateBtn.addEventListener("click", async () => {
          const ok = await copyToClipboard(state.template);
          if (ok) showToast("Template copied");
        });

        copyMessageBtn.addEventListener("click", async () => {
          await refreshShareModalPreviews();
          const ok = await copyToClipboard(shareMessagePreview.value);
          if (ok) showToast("Message copied");
        });

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            if (!shareModal.classList.contains("hidden")) {
              shareModal.classList.add("hidden");
              shareModal.classList.remove("flex");
            }
          }

          if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
            e.preventDefault();
            if (!copyFilledBtn.disabled) copyFilledBtn.click();
          }

          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
            e.preventDefault();
            clearBtn.click();
          }
        });

        /**
         * Initial load
         */
        (async function init() {
          updateThemeIcons();
          createChatbotButtons();

          const loaded = await tryLoadFromUrl();
          if (loaded) {
            titleInput.value = state.title;
            tagsInput.value = state.tags;

            if (state.notes.trim()) {
              notesWrap.classList.remove("hidden");
              toggleNotes.textContent = "âˆ’ Hide notes";
            }
            notesInput.value = state.notes;

            promptInput.value = state.template;

            const varKeys = extractVariables(state.template);
            renderVariables(varKeys);
            updateDerivedViews();

            showToast("Loaded from link");
          } else {
            updateDerivedViews();
            promptInput.focus();
          }
        })();
      });
    </script>
  </body>
</html>
